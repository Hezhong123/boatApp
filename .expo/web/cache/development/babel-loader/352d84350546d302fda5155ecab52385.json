{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport { Audio } from 'expo-av';\nimport { useEffect, useRef, useState } from \"react\";\nimport ActivityIndicator from \"react-native-web/dist/exports/ActivityIndicator\";\nimport Button from \"react-native-web/dist/exports/Button\";\nimport Pressable from \"react-native-web/dist/exports/Pressable\";\nimport Text from \"react-native-web/dist/exports/Text\";\nimport View from \"react-native-web/dist/exports/View\";\nimport { styles } from \"../css\";\nimport axios from \"axios\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nvar url = 'https://boatlmtext.oss-cn-guangzhou.aliyuncs.com';\nexport var Record = function Record(props) {\n  var _useState = useState(false),\n    _useState2 = _slicedToArray(_useState, 2),\n    load = _useState2[0],\n    setLoad = _useState2[1];\n  var _useState3 = useState(),\n    _useState4 = _slicedToArray(_useState3, 2),\n    recording = _useState4[0],\n    setRecording = _useState4[1];\n  var userID = props.userID,\n    start = props.start,\n    stop = props.stop,\n    cb = props.cb;\n\n  function startRecording() {\n    return _startRecording.apply(this, arguments);\n  }\n  function _startRecording() {\n    _startRecording = _asyncToGenerator(function* () {\n      try {\n        start();\n        yield Audio.requestPermissionsAsync();\n        yield Audio.setAudioModeAsync({\n          allowsRecordingIOS: true,\n          playsInSilentModeIOS: true\n        });\n        var _yield$Audio$Recordin = yield Audio.Recording.createAsync(Audio.RecordingOptionsPresets.HIGH_QUALITY),\n          _recording = _yield$Audio$Recordin.recording;\n        setRecording(_recording);\n        console.log('Recording started');\n      } catch (err) {\n        console.error('Failed to start recording', err);\n      }\n    });\n    return _startRecording.apply(this, arguments);\n  }\n  function stopRecording() {\n    return _stopRecording.apply(this, arguments);\n  }\n  function _stopRecording() {\n    _stopRecording = _asyncToGenerator(function* () {\n      if (recording) {\n        var audioName = userID + Math.random().toString(36).substring(2);\n        setRecording(undefined);\n        yield recording.stopAndUnloadAsync();\n        yield Audio.setAudioModeAsync({\n          allowsRecordingIOS: false\n        });\n        console.log('语音时长', recording._finalDurationMillis);\n        stop('null');\n        var formData = new FormData();\n        var data = {\n          uri: recording.getURI(),\n          type: \"audio/webm\"\n        };\n        formData.append('key', \"m4a/\" + audioName + \".m4a\");\n        formData.append('OSSAccessKeyId', 'LTAI7KYTQrVQf2gD');\n        formData.append('signature', 'R2kloMky67ZNHiATW3E8J6PYnGc=');\n        formData.append('policy', 'eyJleHBpcmF0aW9uIjoiMjAyMy0wMS0wMVQxMjowMDowMC4wMDBaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjAwMF1dfQ==');\n        formData.append('success_action_status', 201);\n        formData.append('file', data);\n        setLoad(true);\n        yield axios.post(url, formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          }\n        }).then(function (res) {\n          console.log('上传语音', res.data);\n          setLoad(false);\n          cb(\"https://boatlmtext.oss-cn-guangzhou.aliyuncs.com/m4a/\" + audioName + \".m4a\");\n        }, function (err) {\n          setLoad(false);\n          console.log('上传语音失败', err);\n        });\n      } else {\n        stop('null');\n        console.log(222);\n      }\n    });\n    return _stopRecording.apply(this, arguments);\n  }\n  return _jsx(View, {\n    style: styles.audio,\n    children: load ? _jsx(ActivityIndicator, {}) : _jsx(Pressable, {\n      delayLongPress: 1000,\n      onPressIn: function onPressIn() {\n        return startRecording();\n      },\n      onPressOut: function onPressOut() {\n        return stopRecording();\n      },\n      children: _jsx(Text, {\n        style: {\n          fontSize: 20,\n          marginLeft: 5\n        },\n        children: \"\\uD83C\\uDF99\"\n      })\n    })\n  });\n};","map":{"version":3,"names":["Audio","useEffect","useRef","useState","styles","axios","url","Record","props","load","setLoad","recording","setRecording","userID","start","stop","cb","startRecording","requestPermissionsAsync","setAudioModeAsync","allowsRecordingIOS","playsInSilentModeIOS","Recording","createAsync","RecordingOptionsPresets","HIGH_QUALITY","console","log","err","error","stopRecording","audioName","Math","random","toString","substring","undefined","stopAndUnloadAsync","_finalDurationMillis","formData","FormData","data","uri","getURI","type","append","post","headers","then","res","audio","fontSize","marginLeft"],"sources":["/Users/hez/code/boatApp/src/utils/record.js"],"sourcesContent":["import {Audio} from 'expo-av';\nimport {useEffect, useRef, useState} from \"react\";\nimport {ActivityIndicator, Button, Pressable, Text, View} from \"react-native\";\nimport {styles} from \"../css\";\nimport axios from \"axios\";\n\nlet url = 'https://boatlmtext.oss-cn-guangzhou.aliyuncs.com'\n\nexport const Record = (props) => {\n    const [load, setLoad] = useState(false)\n    const [recording, setRecording] = useState();   //录音器\n    const {userID,start,stop, cb} = props\n\n    // 开始录音\n    async function startRecording() {\n        try {\n            start()\n            await Audio.requestPermissionsAsync();\n            await Audio.setAudioModeAsync({\n                allowsRecordingIOS: true,\n                playsInSilentModeIOS: true,\n            });\n            const {recording} = await Audio.Recording.createAsync(Audio.RecordingOptionsPresets.HIGH_QUALITY\n            );\n            setRecording(recording);\n            console.log('Recording started');\n        } catch (err) {\n            console.error('Failed to start recording', err);\n        }\n    }\n\n    //结束录音\n    async function stopRecording() {\n        if(recording){\n            let audioName = userID+Math.random().toString(36).substring(2);\n            setRecording(undefined);\n            await recording.stopAndUnloadAsync();\n            await Audio.setAudioModeAsync({\n                allowsRecordingIOS: false,\n            });\n            console.log('语音时长',recording._finalDurationMillis)\n            stop('null')\n            // 上传声音文件\n            const formData = new FormData()\n            let data = {\n                uri: recording.getURI(),\n                type: \"audio/webm\"\n            }\n            formData.append('key', `m4a/${audioName}.m4a`)\n            formData.append('OSSAccessKeyId', 'LTAI7KYTQrVQf2gD')\n            formData.append('signature', 'R2kloMky67ZNHiATW3E8J6PYnGc=')\n            formData.append('policy', 'eyJleHBpcmF0aW9uIjoiMjAyMy0wMS0wMVQxMjowMDowMC4wMDBaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjAwMF1dfQ==')\n            formData.append('success_action_status', 201)\n            formData.append('file', data)\n            setLoad(true)\n\n            await axios.post(url, formData, {\n                headers: {\n                    'Content-Type': 'multipart/form-data'\n                }\n            }).then(res => {\n                console.log('上传语音', res.data)\n                setLoad(false)\n                cb(`https://boatlmtext.oss-cn-guangzhou.aliyuncs.com/m4a/${audioName}.m4a`)\n            }, err => {\n                setLoad(false)\n                console.log('上传语音失败', err)\n            })\n        }else {\n            stop('null')\n            console.log(222)\n        }\n\n    }\n\n    return (\n        <View style={styles.audio}>\n            {load ? <ActivityIndicator/> : <Pressable\n                delayLongPress={1000}\n                onPressIn={()=>startRecording()}\n                onPressOut={() => stopRecording()}>\n                <Text style={{fontSize: 20, marginLeft: 5}}>🎙</Text>\n            </Pressable>}\n\n        </View>\n    );\n}\n\n\n\n\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}